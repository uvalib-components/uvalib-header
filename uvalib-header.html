<link rel="import" href="../uvalib-theme/uvalib-ui-element.html">
<link rel="import" href="../uva-helper-libs/polyfills/object.assign.html">
<link rel="import" href="../app-layout/app-header/app-header.html">
<link rel="import" href="../app-layout/app-scroll-effects/effects/waterfall.html">
<link rel="import" href="../uvalib-logos/uvalib-logos.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../iron-form/iron-form.html">
<link rel="import" href="../uvalib-button/uvalib-button.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../uvalib-theme/uvalib-icons.html">
<link rel="import" href="../uva-models/uva-library-alerts.html">
<link rel="import" href="../paper-badge/paper-badge.html">
<link rel="import" href="../uvalib-theme/uvalib-header-style.html">
<link rel="import" href="../polymer/lib/elements/dom-if.html">
<link rel="import" href="../uvalib-search-box/uvalib-search-box.html">
<link rel="import" href="../polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../marked-element/marked-element.html">

<dom-module id="uvalib-header">
  <template>
    <custom-style>
      <style include="uvalib-theme uvalib-header-style">
        nav {
          min-height: 40px;
        }
        nav ul {
          list-style-type: none;
          margin: 0;
          padding: 0;
        }
        nav li {
          display: inline-block;
          color: var(--color-white);
        }
        #menuContainer {
          height: 100%;
          @apply --layout-vertical;
        }
        #alerts {
          background-color: var(--color-primary-orange);
        }
        .alert-item {
          background-color: var(--color-primary-orange);
          border-width: 2px 0 0 0;
          border-color: var(--color-white);
          border-style: solid;
        }
        .alert-item[hot] {
          background-color: var(--color-emergency-red);
        }
        .alert-head {
          @apply --layout-horizontal;
        }
        .alert-title {
          @apply --layout-flex;
        }
      </style>
    </custom-style>

    <uva-library-alerts id="alertsModel" alerts="{{_alerts}}" seen-count="{{_alertSeenCount}}" seen="{{_alertsSeen}}"></uva-library-alerts>

    <paper-dialog id="menuDialog" with-backdrop>
      <div id="menuContainer">
        <div id="menuTop">
          <uvalib-logos stacked text-only reverse></uvalib-logos>
          <div class="spacer"></div>
          <uvalib-button dialog-dismiss>Close x</uvalib-button>
        </div>
        <uvalib-search-box id="sm-search"></uvalib-search-box>
      </div>
    </paper-dialog>
    <app-header id="header" condenses reveals fixed effects="waterfall">
      <div id="top">
        <div>
          <div id="logo">
            <uvalib-logos stacked text-only reverse></uvalib-logos>
          </div>
          <div id="menu">
            <uvalib-button icon="search" reverse outline on-click="_openMenu">Menu</uvalib-button>
          </div>
          <uvalib-search-box id="search"></uvalib-search-box>
        </div>
      </div>
      <div id="bottom" sticky>
        <div id="menu">
          <nav>
            <ul>
              <li>
                <a class="largeScreen" href="/about-uva-library">About</a>
              </li>
              <li>
                <a class="largeScreen" href="/research">Research</a>
              </li>
              <li>
                <a class="largeScreen" href="/collections">Collections</a>
              </li>
              <li>
                <a class="largeScreen" href="/services">Services</a>
              </li>
              <li>
                <a href="/hours"><iron-icon icon="clock-o"></iron-icon> Hours</a>
              </li>
              <li>
                <a href="/askalibrarian"><iron-icon icon="comments"></iron-icon> Ask a Librarian</a>
              </li>
              <li>
                <a href="http://search.lib.virginia.edu/account/review"><iron-icon icon="user"></iron-icon> Account</a>
              </li>
              <template is="dom-if" if="[[_larger(_alertSeenCount,0)]]">
                <li>
                  <a href="" on-click="openAlert">
                    <iron-icon id="alert" icon="envelope-o" alt="Library Alerts"></iron-icon>
                    <paper-badge for="alert" label="[[_alertSeenCount]]"></paper-badge>
                  </a>
                </li>
              </template>
            </ul>

          </nav>
        </div>
        <div id="alerts">
          <dom-repeat items="[[_alerts]]" as="alert">
            <template>
              <iron-collapse opened$="[[!alert.seen]]">
                <div class="alert-item" hot$="[[_isHot(alert.severity)]]" uuid="[[alert.uuid]]">
                  <div class="alert-head">
                    <div class="alert-title" on-click="_toggleIt">[[alert.title]]</div>
                    <template is="dom-if" if="[[!_isHot(alert.severity)]]">
                      <uvalib-button on-click="_toggleIt">More</uvalib-button>
                      <uvalib-button on-click="_dismissIt">Dismiss</uvalib-button>
                    </template>
                  </div>
                  <iron-collapse class="body-collapse" opened$="[[_isHot(alert.severity)]]">
                    <div class="alert-body">
                      <marked-element markdown="[[alert.body]]">
                        <div slot="markdown-html"></div>
                      </marked-element>
                    </div>
                  </iron-collapse>
                </div>
              </iron-collapse>
            </template>
          </dom-repeat>
        </div>
      </div>
    </app-header>
  </template>

  <script>

    /**
     * `uvalib-header`
     * Header element for the UVA Library web apps
     *
     * ### Styling
     *
     * `<uvalib-header>` provides the following custom properties and mixins for styling:
     *
     * Custom property | Description | Default
     * ----------------|-------------|----------
     * `--uvalib-header-height-lg` | The elements height when `largeScreen` is true | `253px`
     * `--uvalib-header-height-md` | The elements height when `mediumScreen` is true | `156px`
     * `--uvalib-header-height-sm` | The elements height when `smallScreen` is true | `128px`
     * `--uvalib-header-background-color` | Background color of the header element | '--color-primary-color'
     * `--uvalib-header-nav-background-color` | Background color of the header nav section (for large screens) | `--color-secondary-blue`
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class UvalibHeader extends UvalibUiElement {
      static get is() { return 'uvalib-header'; }
      static get properties() {
        return Object.assign(super.properties,
            {
              _alertsSeen: {
                type: Array,
                notify: true
              },
              _virgoSearchUrl: {
                type: String,
                value: "https://search.lib.virginia.edu/catalog"
              },
              _query: String,
              _searchVirgoPlaceholder: {
                type: String,
                value: "Search Virgo for books, articles, digital materials, and more."
              }
            });
      }
      //Concat the this elements template with the parents
      static get template() {
        var parentTemplate = UvalibUiElement.template.cloneNode(true);
        var childTemplate = Polymer.DomModule.import('uvalib-header', 'template');
        parentTemplate.content.insertBefore(childTemplate.content,null);
        return parentTemplate;
      }
      connectedCallback() {
        super.connectedCallback();
        this._adjustHeight();
      }
      _adjustHeight() {
        console.log(this.$.header.clientHeight)
        this.style.height=this.$.header.clientHeight+"px";
      }
      submitCatalogSearch() {
        this.$.virgoSearchForm.submit();
      }
      _checkForEnterVirgo(e) {
          // check if 'enter' was pressed
          if (e.keyCode === 13) {
              this.submitCatalogSearch();
          }
      }
      _openMenu(){
        this.$.menuDialog.open();
      }
      openAlert(e){
        e.preventDefault();
        this.set('_alertsSeen',[]);
      }
      _toggleIt(e){
        e.currentTarget.parentElement.parentElement.querySelector('.body-collapse').toggle();
      }
      _dismissIt(e){
        var uuid = e.currentTarget.parentElement.parentElement.uuid;

        // Have to be a bit harsh here to get this change notified for some reason
        this.$.alertsModel.setSeen(uuid);
      }
      _isHot(severity){
        return (severity==="alert1");
      }
    }

    window.customElements.define(UvalibHeader.is, UvalibHeader);
  </script>
</dom-module>
